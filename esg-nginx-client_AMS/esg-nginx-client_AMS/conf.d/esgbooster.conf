server {
                listen 443;
                listen [::]:443;
                #index index.html index.htm;
                server_name finlabs-esg-booster-ext.synechron.net; 
                #root /usr/local/esg/syne-toolkit/build;

        location / {
        	index  index.html index.htm;
	        auth_request     /auth;
                auth_request_set $auth_cookie $upstream_http_set_cookie;
                add_header Set-Cookie $auth_cookie;
                auth_request_set $auth_status $upstream_status;
                auth_request_set $auth_authorization $upstream_http_authorization;
                add_header x-sec-code $auth_authorization;
                add_header Authorization $cookie_jwtToken;
                add_header X-Original-URI $request_uri;
                proxy_set_header X-Original-URI $request_uri;
                # WHITELIST START
                add_header X-Real-IP $remote_addr;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_redirect http:// https://;
                proxy_set_header Host $host;
                # WHITELIST END                
                proxy_pass http://172.17.60.119:3000/;
          if ($arg_jwtToken) {
            add_header X-Original-URI $arg_jwtToken;
            set $mToken $arg_jwtToken;
            add_header Authorization $arg_jwtToken;
            add_header Set-Cookie jwtToken=$mToken;
            set $args '';
            return 302 / ;
            }
        }

        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_ssl_server_name on;
        error_page 401 = @error401;
        location @error401 {
                return 302 https://finlabs-auth.synechron.net/authenticate?post-authentication-binding=https://$server_name;
        }

        #SSO
        location = /auth {
                internal;
                proxy_pass https://finlabs-gateway.synechron.net;
                proxy_pass_request_body     off;
                proxy_set_header        Content-Length "";
                proxy_set_header        X-Original-URI $request_uri;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_pass_header X-Real_IP;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header $uri $uri;
                proxy_set_header Cookie $http_cookie;
                proxy_pass_header Authorization;
                proxy_set_header X-Auth-Type "authentication";
                proxy_pass_header X-Auth-Type;
                proxy_set_header X-App http://$server_name;
                proxy_pass_header X-App;
                proxy_pass_request_headers on;
                }

        location ~ ^/(static|assets)/ {
                proxy_set_header X-Real_IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-NginX-Proxy true;
                real_ip_header X-Real-IP;
                proxy_pass http://172.17.60.119:3000;
                }

         location /portfolio-mgmt/ {
                auth_request     /auth;
                proxy_pass http://172.17.60.119:8081/portfolio-mgmt/;
                proxy_redirect http:// https://;
                proxy_set_header Host $host;
                proxy_redirect default;
            #    proxy_set_header X-Real-IP $remote_addr;

            #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            #    proxy_set_header X-Forwarded-Proto $scheme;
         }

        location /minio/ {
                auth_request     /auth;
                proxy_pass http://172.17.60.119:9000;
                proxy_redirect http:// https://;

        }

        location /news/ {
                auth_request     /auth;
                proxy_pass http://172.17.60.119:8099/news/;
                proxy_redirect http:// https://;
                proxy_set_header Host $host;
                proxy_redirect default;
        }

        location /benchmark/ {
                auth_request     /auth;
                proxy_pass http://172.17.60.119:8095/benchmark/;
                proxy_redirect http:// https://;
                proxy_set_header Host $host;
                proxy_redirect default;
        }



        location /master-universe/ {
                auth_request     /auth;
                proxy_pass http://172.17.60.119:8092/master-universe/;
                proxy_redirect http:// https://;
                proxy_set_header Host $host;
                proxy_redirect default;
        }

        location /alternative-service/ {
                auth_request     /auth;
                proxy_pass http://172.17.60.119:8096/alternative-service/;
                proxy_redirect http:// https://;
                proxy_set_header Host $host;
                proxy_redirect default;
        }

        location /calculation/ {
                auth_request     /auth;
                proxy_pass http://172.17.60.119:8094/calculation/;
                proxy_redirect http:// https://;
                proxy_set_header Host $host;
                proxy_redirect default;
        }

        location /discovery/ {
                auth_request     /auth;
                proxy_pass http://172.17.60.119:9200/;
                proxy_redirect http:// https://;
        }

         location /risk-profiler/ {
                auth_request     /auth;
           proxy_redirect http:// https://;
           proxy_set_header Host $host;
           proxy_pass http://172.17.60.119:8082/risk-profiler/;
           proxy_redirect default;
        }

        location /aws/ {
                auth_request     /auth;

                proxy_pass http://172.17.60.119:3020/;
                proxy_redirect http:// https://;
        }



                ssl on;
                ssl_certificate /etc/ssl/private/synechron-net.crt;
                ssl_certificate_key /etc/ssl/private/synechron-net.key;
                #ssl_certificate /etc/ssl/private/synechronfinlabs-net.crt;
                #ssl_certificate_key /etc/ssl/private/synechronfinlabs-net.key;
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers TLS-CHACHA20-POLY1305-SHA256:TLS-AES-256-GCM-SHA384:TLS-AES-128-GCM-SHA256:HIGH:!aNUL$;

}

